name: Build new packages
on: push

jobs:
  build:
    runs-on: ubuntu-20.04
    container: archlinux:base-devel-20210131.0.14634

    steps:
      - name: Checkout code
        uses: actions/checkout@v2
      - name: Add pacman repo
        run: |
            cat<<EOF >> /etc/pacman.conf
            [crepo]
            SigLevel = Optional TrustAll DatabaseOptional
            Server = https://babarulea.000webhostapp.com/arch/
            EOF
      - run: |
          pacman -Sy
          pacman -U --noconfirm https://archive.archlinux.org/repos/2021/02/01/extra/os/x86_64/git-2.30.0-1-x86_64.pkg.tar.zst
          pacman -Sy rclone paru --noconfirm
          useradd -m user
          echo "user ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers
      - run: su user -c ./build.sh
      - name: Setup rclone
        run: |
          mkdir -p ~/.config/rclone
          cat <<EOF > ~/.config/rclone/rclone.conf
          ${{ secrets.RCLONE_CONFIG }}
          EOF
          rclone ls ff:/public_html
      - run: |
          cd /tmp/crepo
          ls
          rclone copy . ff:/public_html/arch --progress --copy-links

